---
layout: post
title: "Adding Sorbet and Tapioca to a Jumpstart Pro app"
date: 2023-09-17
published: true
---
This post describes the process of setting up Sorbet and Tapioca for the [Jumpstart Pro](https://jumpstartrails.com) Rails template.

Since Jumpstart Pro is a commercial product, I can’t share the full code, but if you’re a Jumpstart customer you can view the changes in [this branch](https://github.com/andyw8/jumpstart-pro-rails/tree/andyw8/sorbet) of my fork. I recommend viewing it as individual commits.

For this post, I'll assume you are starting from a freshly generated Jumpstart app. If you have already built your app on top of Jumpstart then it may take some more effort but the overall approach is the same.

I'll demonstrate the process in incremental steps, so your app can continue to be deployed while type information is still being added. This follows Sorbet's philosophy of [Gradual Typing](https://sorbet.org/docs/gradual).

## Preparation

Start by creating a `sorbet` branch for the Sorbet migration. This will be fairly short-lived, and only needed for the initial setup.

## CI

Although Jumpstart provides a GitHub Actions CI script, we'll instead use [setup-rails](https://www.andywaite.com/2022/04/15/reusable-github-actions-rails-workflow.html) since it will detect if Sorbet is in use and run additional checks. We'll also enable the `standard` option, since that's what Jumpstart uses instead of RuboCop.

```yml
name: Verify
on: [push, pull_request]

jobs:
  verify:
    uses: setup-rails/setup-rails/.github/workflows/verify.yml@main
    with:
      run-before-tests: sudo apt-get install -y -qq libvips
      standard: true
```

(I also had to disable parallel testing by commenting-out the `parallelize` line in `test_helper.rb`, as I found it was causing the tests to hang. I haven't had a chance yet to look into the cause.)

## Basic Setup

Overall, the setup for Jumpstart Pro is not so different than for any other Rails app, but the optional dependencies complicate things a little: If there is code that references a gem that isn’t installed, then typechecking will fail. To simplify things for this guide, we can open the Jumpstart configuration and enable the following features:

* Payment Processor: Stripe
* Background Queue: Sidekiq
* ActsAsTenant
* Facebook Omniauth Provider

This should result in additions to `Gemfile.lock` which you should commit.

Next, we'll add the `sorbet-static-and-runtime` and `tapoica` gems to the `Gemfile`, run `bundle` then `bundle exec tapioca init`.

The `init` command can take a long time to run (10 minutes or more), and it may seem like it has frozen. Have patience!

You may be alarmed by the huge number of RBI files this creates, but you will very rarely need to open them.

After this is complete, we can commit everything.

We can now run the typechecking:

`$ bundle exec srb tc`

We should see about 20 errors. It's common to encounter errors when setting up Sorbet initially, often due to known limitations in Sorbet or Tapioca.

Several are due [potentially ambiguous](https://sorbet.org/docs/error-reference#5068) definitions, which are easily fixed by using the full version of the definition.

Other errors are because some parts of the gem are not required by default. We need to add an entry to `require.rb`:

```yml
require "administrate/base_dashboard"
``````

and then re-run `bundle exec tapioca gem administrate`.

After this there should be only one remaining error, which is due to the Sorbet limitation that "include must only contain constant literals". For now, we can just add `# typed: ignore` for this file.

At this point you can push to CI and everything should be green again. If you wish, you can merge the `sorbet` branch into `main` and continue the remaining work in other branches.

Although we are no longer seeing any typechecking errors, some things are being ignored because they are listed in `todo.rb` which was generated by `sorbet init`. We should aim to eliminate these before continuing.

We intentionally never manually edit `todo.rb` - we’ll make a change, and then regenerate it, to gradually reduce the number of entries.

Many of the remaining entries in `todo.rb` are due to optional gems, where they are conditionally referenced in an initializer. We can mark these as `# typed: ignore`, then regenerate `todo.rb`.

Next, we have some entries in `todo.rb` that relate to the Devise and Noticed gems. For gems that make use of metaprogramming, we often need to give Sorbet some help to adding [shims](https://sorbet.org/docs/rbi).

```ruby
# sorbet/shims.rbi
class Devise::OmniauthCallbacksController; end
class Devise::RegistrationsController; end
class Devise::SessionsController; end

class Noticed::NotificationChannel; end
```

For `Minitest::Mock` and `Sidekiq::Web` we again need to add entries to `require.rb`:

```ruby
require "minitest/mock"
require "sidekiq/web"
```

At this point, there should be no more entries in `todo.rb` and running `tapioca todo` will delete it.

## Standard

Although Jumpstart uses Standard rather than RuboCop, there are some useful cops in `rubocop-sorbet`, so we will add as a dependency.

Then in `.standard.yml`, we’ll use Standard’s [extend_config](https://blog.testdouble.com/posts/2023-01-19-super-standard-adding-gem-extensions-and-custom-rules/) feature to reference a RuboCop Sorbet configuration file:

```yml
# .standard.yml
extend_config:
  - .rubocop_sorbet.yml
```

The config will look like this:

```yml
# .rubocop_sorbet.yml
AllCops:
  NewCops: disable
  Exclude:
    - lib/jumpstart/test/dummy/**/*
Sorbet/FalseSigil:
  Enabled: false
Sorbet/HasSigil:
  Enabled: true
Sorbet/ConstantsFromStrings:
  Exclude:
    - 'app/models/connected_account.rb'
```

I'll explain the above:

We’ll disable the `FalseSigil` check for now, since otherwise, we would have failures due to the `# typed: ignore` entries added earlier. But we’ll enable `HasSigil` to ensure that any new files we add have a sigil.

We’ll also ignore the Dummy app used by the internal jumpstart gem, since that should be treated as a separate application.

Finally, we need to disable the ConstantsFromStrings check for one file, due to  Sorbet's limitations for `const_get`.

With that done, we can now run `bundle exec standardrb --fix` which will add a `typed: false` entry to each file.

On its own that doesn't do anything, but it prepares the way that we can use Spoom.

## Spoom

Spoom consists of various tools, one of which is the `bump` command:

```sh
bundle exec spoom bump
```
This helps us discover which files can be 'bumped' up a level of typing.

You should see that a large number are now marked as `# typed: true`, without us having to do any work.

## Next Steps

At this point, you can search for `# typed: false` in `*.rb` and you’ll see there are around 100 files remaining that we need to enable typing for.  Resolving those is outside the scope of this article, but you now have a strong starting point.

You’ll notice that we haven’t written any signatures yet. But even without that, we will benefit from Sorbet’s checks for things such as calls to non-existing methods, or unreachable code.
